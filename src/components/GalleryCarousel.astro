---
/**
 * Premium GalleryCarousel Component
 * Results gallery with lightbox, filters, and elegant animations
 */
interface GalleryImage {
  src: string;
  alt?: string;
  category?: string;
  procedure?: string;
}

interface Props {
  title?: string;
  subtitle?: string;
  description?: string;
  images?: (string | GalleryImage)[];
  categories?: string[];
  showFilters?: boolean;
  showLightbox?: boolean;
  columns?: 2 | 3 | 4;
  variant?: 'carousel' | 'grid' | 'masonry';
}

const {
  title = "Transformaciones Reales",
  subtitle = "GalerÃ­a de Resultados",
  description = "Descubre los resultados excepcionales que hemos logrado para nuestros pacientes",
  images = [
    { src: "/images/3.png" },
    { src: "/images/4.png" },
    { src: "/images/5.png" },
    { src: "/images/7.png" },
    { src: "/images/8.png" },
    { src: "/images/13.png" },
    { src: "/images/31.png" },
    { src: "/images/15.png" },
    { src: "/images/40.png" },
    { src: "/images/18.png" },
    { src: "/images/52.png" },
    { src: "/images/20.png" },
    { src: "/images/27.png" },
    { src: "https://thetrueyou.com.co/wp-content/uploads/2025/06/r5-e1753806750418.webp" }
  ],
  categories = [],
  showFilters = false,
  showLightbox = true,
  columns = 3,
  variant = 'carousel'
} = Astro.props;

// Normalize images to GalleryImage format
const normalizedImages: GalleryImage[] = images.map((img, index) => {
  if (typeof img === 'string') {
    return { src: img, alt: `Resultado ${index + 1}`, category: 'Todos' };
  }
  return { ...img, alt: img.alt || `Resultado ${index + 1}` };
});
---

<section class="w-full bg-white py-16 md:py-24" data-gallery-section>
  <div class="container-premium">
    <!-- Header -->
    <div class="text-center mb-12 animate-on-scroll">
      {subtitle && (
        <span class="inline-flex items-center gap-2 px-4 py-2 bg-primary-100 rounded-full text-sm font-medium text-primary-700 mb-4">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          {subtitle}
        </span>
      )}

      <h2 class="font-serif text-3xl md:text-4xl lg:text-5xl font-bold text-dark leading-tight mb-4">
        {title}
      </h2>

      {description && (
        <p class="text-lg text-dark/70 leading-relaxed max-w-2xl mx-auto">
          {description}
        </p>
      )}
    </div>

    <!-- Filter Tabs -->
    {showFilters && categories.length > 1 && (
      <div class="flex flex-wrap justify-center gap-2 mb-10 animate-on-scroll" data-filter-tabs>
        {categories.map((category, index) => (
          <button
            class={`px-5 py-2.5 rounded-full text-sm font-medium transition-all duration-300 ${
              index === 0
                ? 'bg-primary text-white shadow-lg'
                : 'bg-primary-50 text-primary-700 hover:bg-primary-100'
            }`}
            data-filter={category}
          >
            {category}
          </button>
        ))}
      </div>
    )}

    {variant === 'carousel' ? (
      <!-- Carousel View -->
      <div class="relative animate-on-scroll" data-gallery-carousel>
        <!-- Navigation Buttons -->
        <button
          class="gallery-prev absolute left-0 md:-left-5 top-1/2 -translate-y-1/2 z-10 w-12 h-12 bg-white rounded-full shadow-xl border border-primary-100 flex items-center justify-center hover:bg-primary-50 transition-all duration-300 group"
          aria-label="Anterior"
        >
          <svg class="w-5 h-5 text-primary-600 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>

        <button
          class="gallery-next absolute right-0 md:-right-5 top-1/2 -translate-y-1/2 z-10 w-12 h-12 bg-white rounded-full shadow-xl border border-primary-100 flex items-center justify-center hover:bg-primary-50 transition-all duration-300 group"
          aria-label="Siguiente"
        >
          <svg class="w-5 h-5 text-primary-600 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>

        <!-- Carousel Container -->
        <div class="overflow-hidden mx-8 md:mx-0">
          <div class="gallery-track flex transition-transform duration-500 ease-out" data-gallery-track>
            {normalizedImages.map((image, index) => (
              <div
                class="gallery-item flex-shrink-0 px-2 md:px-3"
                data-category={image.category || 'Todos'}
                style={`width: ${100 / columns}%`}
              >
                <div
                  class="relative group cursor-pointer rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-500"
                  data-lightbox-trigger={showLightbox ? index : undefined}
                >
                  <!-- Image -->
                  <div class="aspect-[4/5] bg-primary-50">
                    <img
                      src={image.src}
                      alt={image.alt}
                      class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700"
                      loading="lazy"
                    />
                  </div>

                  <!-- Overlay -->
                  <div class="absolute inset-0 bg-gradient-to-t from-dark/60 via-dark/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <!-- Zoom Icon -->
                    <div class="absolute inset-0 flex items-center justify-center">
                      <div class="w-14 h-14 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center transform scale-75 group-hover:scale-100 transition-transform duration-300">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                        </svg>
                      </div>
                    </div>

                    <!-- Info -->
                    <div class="absolute bottom-0 left-0 right-0 p-4">
                      {image.procedure && (
                        <p class="text-white font-semibold text-sm mb-1">{image.procedure}</p>
                      )}
                      {image.category && (
                        <span class="inline-block px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-xs text-white">
                          {image.category}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Progress & Counter -->
        <div class="flex items-center justify-center gap-6 mt-8">
          <!-- Counter -->
          <span class="text-dark/60 text-sm font-medium">
            <span class="gallery-current text-dark font-semibold">01</span>
            <span class="mx-1">/</span>
            <span class="gallery-total">{String(normalizedImages.length).padStart(2, '0')}</span>
          </span>

          <!-- Progress Bar -->
          <div class="w-48 h-1 bg-primary-100 rounded-full overflow-hidden">
            <div class="gallery-progress h-full bg-primary rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>

          <!-- Dots (optional for smaller sets) -->
          <div class="hidden md:flex items-center gap-1.5 gallery-dots">
            {normalizedImages.slice(0, Math.min(normalizedImages.length, 10)).map((_, index) => (
              <button
                class={`w-2 h-2 rounded-full transition-all duration-300 ${index === 0 ? 'bg-primary w-6' : 'bg-primary-200 hover:bg-primary-300'}`}
                data-dot={index}
                aria-label={`Ir a imagen ${index + 1}`}
              />
            ))}
          </div>
        </div>
      </div>
    ) : (
      <!-- Grid View -->
      <div class={`grid gap-4 md:gap-6 animate-on-scroll ${
        columns === 2 ? 'grid-cols-1 sm:grid-cols-2' :
        columns === 4 ? 'grid-cols-2 md:grid-cols-3 lg:grid-cols-4' :
        'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3'
      }`} data-gallery-grid>
        {normalizedImages.map((image, index) => (
          <div
            class="gallery-grid-item"
            data-category={image.category || 'Todos'}
          >
            <div
              class="relative group cursor-pointer rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-500"
              data-lightbox-trigger={showLightbox ? index : undefined}
            >
              <div class="aspect-[4/5] bg-primary-50">
                <img
                  src={image.src}
                  alt={image.alt}
                  class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700"
                  loading="lazy"
                />
              </div>

              <div class="absolute inset-0 bg-gradient-to-t from-dark/60 via-dark/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="w-14 h-14 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center transform scale-75 group-hover:scale-100 transition-transform duration-300">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                    </svg>
                  </div>
                </div>

                <div class="absolute bottom-0 left-0 right-0 p-4">
                  {image.category && (
                    <span class="inline-block px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-xs text-white">
                      {image.category}
                    </span>
                  )}
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}

    <!-- CTA -->
    <div class="text-center mt-12 animate-on-scroll">
      <a href="#contactForm" class="btn-primary scroll-to-contact">
        Agenda Tu Consulta Gratuita
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
        </svg>
      </a>
    </div>
  </div>

  <!-- Lightbox Modal -->
  {showLightbox && (
    <div
      class="fixed inset-0 z-[100] bg-dark/95 backdrop-blur-sm opacity-0 invisible transition-all duration-300"
      data-lightbox-modal
    >
      <!-- Close Button -->
      <button
        class="absolute top-4 right-4 z-10 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors"
        data-lightbox-close
        aria-label="Cerrar"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>

      <!-- Navigation -->
      <button
        class="absolute left-4 top-1/2 -translate-y-1/2 z-10 w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors group"
        data-lightbox-prev
        aria-label="Anterior"
      >
        <svg class="w-6 h-6 text-white group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>

      <button
        class="absolute right-4 top-1/2 -translate-y-1/2 z-10 w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors group"
        data-lightbox-next
        aria-label="Siguiente"
      >
        <svg class="w-6 h-6 text-white group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>

      <!-- Image Container -->
      <div class="absolute inset-0 flex items-center justify-center p-4 md:p-16">
        <img
          src=""
          alt=""
          class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transform scale-95 transition-transform duration-300"
          data-lightbox-image
        />
      </div>

      <!-- Counter -->
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-white/10 rounded-full text-white text-sm font-medium">
        <span data-lightbox-current>1</span> / <span data-lightbox-total>{normalizedImages.length}</span>
      </div>
    </div>
  )}
</section>

<style>
  /* Animate on scroll */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
  }

  [data-gallery-section].is-visible .animate-on-scroll {
    opacity: 1;
    transform: translateY(0);
  }

  [data-gallery-section].is-visible .animate-on-scroll:nth-child(2) {
    transition-delay: 0.1s;
  }

  [data-gallery-section].is-visible .animate-on-scroll:nth-child(3) {
    transition-delay: 0.2s;
  }

  /* Lightbox active state */
  [data-lightbox-modal].is-active {
    opacity: 1;
    visibility: visible;
  }

  [data-lightbox-modal].is-active [data-lightbox-image] {
    transform: scale(1);
  }

  /* Grid item filter animation */
  .gallery-grid-item {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .gallery-grid-item.is-hidden {
    opacity: 0;
    transform: scale(0.8);
    position: absolute;
    visibility: hidden;
  }

  /* Responsive columns for carousel */
  @media (max-width: 768px) {
    .gallery-item {
      width: 100% !important;
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    .gallery-item {
      width: 50% !important;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Intersection Observer for section visibility
    const sections = document.querySelectorAll('[data-gallery-section]');
    const sectionObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
        }
      });
    }, { threshold: 0.1 });

    sections.forEach(section => sectionObserver.observe(section));

    // Gallery Carousel
    const carousels = document.querySelectorAll('[data-gallery-carousel]');

    carousels.forEach(carousel => {
      const track = carousel.querySelector('[data-gallery-track]') as HTMLElement;
      const items = carousel.querySelectorAll('.gallery-item');
      const prevBtn = carousel.querySelector('.gallery-prev');
      const nextBtn = carousel.querySelector('.gallery-next');
      const progress = carousel.querySelector('.gallery-progress') as HTMLElement;
      const currentEl = carousel.querySelector('.gallery-current');
      const totalEl = carousel.querySelector('.gallery-total');
      const dots = carousel.querySelectorAll('[data-dot]');

      if (!track || items.length === 0) return;

      let currentIndex = 0;
      const totalItems = items.length;
      let autoplay: ReturnType<typeof setInterval>;

      function getItemsPerView() {
        if (window.innerWidth < 769) return 1;
        if (window.innerWidth < 1025) return 2;
        return 3;
      }

      function updateCarousel() {
        const itemsPerView = getItemsPerView();
        const itemWidthPercent = 100 / itemsPerView;
        const translateX = currentIndex * itemWidthPercent;
        track.style.transform = `translateX(-${translateX}%)`;

        // Update counter
        if (currentEl) {
          currentEl.textContent = String(currentIndex + 1).padStart(2, '0');
        }
        if (totalEl) {
          totalEl.textContent = String(totalItems).padStart(2, '0');
        }

        // Update progress
        if (progress) {
          const progressPercentage = ((currentIndex + 1) / totalItems) * 100;
          progress.style.width = `${progressPercentage}%`;
        }

        // Update dots
        dots.forEach((dot, index) => {
          if (index === currentIndex) {
            dot.classList.add('bg-primary', 'w-6');
            dot.classList.remove('bg-primary-200');
          } else {
            dot.classList.remove('bg-primary', 'w-6');
            dot.classList.add('bg-primary-200');
          }
        });
      }

      function next() {
        currentIndex = (currentIndex + 1) % totalItems;
        updateCarousel();
      }

      function prev() {
        currentIndex = (currentIndex - 1 + totalItems) % totalItems;
        updateCarousel();
      }

      prevBtn?.addEventListener('click', prev);
      nextBtn?.addEventListener('click', next);

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          currentIndex = index;
          updateCarousel();
        });
      });

      // Touch support
      let startX = 0;
      let isDragging = false;

      track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      }, { passive: true });

      track.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;

        const endX = e.changedTouches[0].clientX;
        const diffX = startX - endX;

        if (Math.abs(diffX) > 50) {
          if (diffX > 0) next();
          else prev();
        }
      }, { passive: true });

      // Resize handler
      window.addEventListener('resize', updateCarousel);

      // Initial setup
      updateCarousel();

      // Autoplay
      autoplay = setInterval(next, 5000);

      carousel.addEventListener('mouseenter', () => clearInterval(autoplay));
      carousel.addEventListener('mouseleave', () => {
        autoplay = setInterval(next, 5000);
      });
    });

    // Lightbox functionality
    const lightboxModal = document.querySelector('[data-lightbox-modal]') as HTMLElement;
    const lightboxImage = document.querySelector('[data-lightbox-image]') as HTMLImageElement;
    const lightboxCurrent = document.querySelector('[data-lightbox-current]');
    const lightboxClose = document.querySelector('[data-lightbox-close]');
    const lightboxPrev = document.querySelector('[data-lightbox-prev]');
    const lightboxNext = document.querySelector('[data-lightbox-next]');
    const lightboxTriggers = document.querySelectorAll('[data-lightbox-trigger]');

    if (lightboxModal && lightboxImage) {
      let currentLightboxIndex = 0;
      const lightboxImages: { src: string; alt: string }[] = [];

      lightboxTriggers.forEach((trigger, index) => {
        const img = trigger.querySelector('img');
        if (img) {
          lightboxImages.push({
            src: img.src,
            alt: img.alt
          });
        }

        trigger.addEventListener('click', () => {
          currentLightboxIndex = index;
          openLightbox(index);
        });
      });

      function openLightbox(index: number) {
        if (lightboxImages[index]) {
          lightboxImage.src = lightboxImages[index].src;
          lightboxImage.alt = lightboxImages[index].alt;
          if (lightboxCurrent) {
            lightboxCurrent.textContent = String(index + 1);
          }
          lightboxModal.classList.add('is-active');
          document.body.style.overflow = 'hidden';
        }
      }

      function closeLightbox() {
        lightboxModal.classList.remove('is-active');
        document.body.style.overflow = '';
      }

      function nextImage() {
        currentLightboxIndex = (currentLightboxIndex + 1) % lightboxImages.length;
        openLightbox(currentLightboxIndex);
      }

      function prevImage() {
        currentLightboxIndex = (currentLightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
        openLightbox(currentLightboxIndex);
      }

      lightboxClose?.addEventListener('click', closeLightbox);
      lightboxNext?.addEventListener('click', nextImage);
      lightboxPrev?.addEventListener('click', prevImage);

      lightboxModal.addEventListener('click', (e) => {
        if (e.target === lightboxModal) closeLightbox();
      });

      document.addEventListener('keydown', (e) => {
        if (!lightboxModal.classList.contains('is-active')) return;

        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') nextImage();
        if (e.key === 'ArrowLeft') prevImage();
      });
    }
  });
</script>
